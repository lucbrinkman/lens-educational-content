name: Validate

on:
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual "Run workflow" button
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || 'staging' }}
          fetch-depth: 2

      - name: Check if should run (for scheduled runs)
        id: check
        if: github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "Current commit: $CURRENT_SHA"

          # Skip if commit is less than 5 minutes old (still editing)
          COMMIT_TIME=$(git log -1 --format=%ct)
          NOW=$(date +%s)
          COMMIT_AGE=$((NOW - COMMIT_TIME))

          if [ $COMMIT_AGE -lt 300 ]; then
            echo "::notice title=Validation Skipped::Commit is ${COMMIT_AGE}s old (< 5min), still being edited"
            exit 78
          fi

          # Check if this commit already has a validation status
          VALIDATED=$(gh api repos/${{ github.repository }}/commits/$CURRENT_SHA/statuses \
            --jq '.[] | select(.context == "validation/modules") | .state' 2>/dev/null | head -1 || echo "")

          if [ -n "$VALIDATED" ]; then
            echo "::notice title=Validation Skipped::Commit already validated (result: $VALIDATED)"
            exit 78
          fi

          echo "Will validate commit $CURRENT_SHA"
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "sha=$CURRENT_SHA" >> $GITHUB_OUTPUT

      - name: Set up Python
        if: github.event_name != 'schedule' || steps.check.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Validate lesson format
        id: validate
        if: github.event_name != 'schedule' || steps.check.outputs.should_run == 'true'
        run: |
          curl -sO https://raw.githubusercontent.com/lucbrinkman/ai-safety-course-platform/staging/core/modules/markdown_validator.py
          python markdown_validator.py ./modules/ ./courses/

      - name: Record validation result
        if: (github.event_name != 'schedule' || steps.check.outputs.should_run == 'true') && always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA=${{ steps.check.outputs.sha || github.sha }}
          if [ "${{ steps.validate.outcome }}" == "success" ]; then
            STATE="success"
            DESC="Validation passed"
          else
            STATE="failure"
            DESC="Validation failed"
          fi
          
          gh api repos/${{ github.repository }}/statuses/$SHA \
            -f state="$STATE" \
            -f context="validation/modules" \
            -f description="$DESC" || echo "Failed to set status"
